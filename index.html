<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Form Laporan Kerusakan</title>
<link rel="stylesheet" href="style.css" />
<link rel="manifest" href="manifest.json" />
<style>
  body { font-family: Arial; margin:0; padding:0; background:#f5f5f5; }
  main { max-width:500px; margin:auto; padding:20px; }
  label { display:block; margin-bottom:12px; }
  input, select, textarea { width:100%; padding:8px; margin-top:4px; border-radius:6px; border:1px solid #ccc; }
  button { padding:10px 18px; border:none; border-radius:6px; background:#0b63d6; color:#fff; font-size:16px; cursor:pointer; margin-right:10px; }
  .muted { background:#999; }
  .status { margin-top:10px; font-weight:bold; color:#0b63d6; }
  video { width:100%; border-radius:10px; margin-bottom:10px; background:black; }
  #preview { width:100%; margin-top:10px; display:none; border-radius:10px; }
</style>
</head>
<body>
<main>
  <h1>Aplikasi Lapor Kerusakan</h1>

  <form id="laporForm">
    <label>Nama Pelapor
      <input type="text" id="nama" required />
    </label>

    <label>Divisi / Ruangan
      <input type="text" id="divisi" required />
    </label>

    <label>Jenis Kendala
      <select id="jenis" required>
        <option value="Listrik">Listrik</option>
        <option value="Internet">Internet</option>
        <option value="Komputer">Komputer</option>
        <option value="Lainnya">Lainnya</option>
      </select>
    </label>

    <label>Deskripsi Kendala
      <textarea id="deskripsi" rows="4" required></textarea>
    </label>

    <label>Foto Bukti (otomatis dari kamera)
      <video id="camera" autoplay playsinline></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <img id="preview"/>
      <button type="button" id="takePhoto">ðŸ“¸ Ambil Foto</button>
    </label>

    <div class="row" style="margin-top:10px;">
      <button type="submit" id="btnSubmit">Kirim Laporan</button>
      <button type="reset" id="btnReset" class="muted">Reset</button>
    </div>

    <div id="statusMsg" class="status"></div>
  </form>

  <p class="hint">Form akan mengirim ke Google Sheets & menyimpan foto ke Google Drive.</p>
</main>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbycJc7oMgPazk-IPfeE7F7GaFsMK9NWZM6bylP91rP8kgtqP07XH6goyqGltE32jIl6/exec";

const video = document.getElementById('camera');
const canvas = document.getElementById('canvas');
const preview = document.getElementById('preview');
let imgData = null;

// Mulai kamera
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
  }catch(err){
    alert("Tidak bisa akses kamera: " + err);
  }
}
startCamera();

// Ambil foto
document.getElementById('takePhoto').onclick = () => {
  const w = video.videoWidth;
  const h = video.videoHeight;

  // Resize foto max 800px lebar
  const maxWidth = 800;
  let scale = w > maxWidth ? maxWidth / w : 1;
  canvas.width = w * scale;
  canvas.height = h * scale;

  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  imgData = canvas.toDataURL("image/jpeg", 0.5); // kualitas 50%

  preview.src = imgData;
  preview.style.display = "block";
  alert("Foto berhasil diambil!");
};

// Submit form
document.getElementById('laporForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const nama = document.getElementById('nama').value.trim();
  const divisi = document.getElementById('divisi').value.trim();
  const jenis = document.getElementById('jenis').value;
  const deskripsi = document.getElementById('deskripsi').value.trim();

  const statusMsg = document.getElementById('statusMsg');
  statusMsg.textContent = 'Mengunggah...';

  try{
    const payload = {
      action: 'add',
      nama, divisi, jenis, deskripsi,
      fotoDataUrl: imgData
    };

    const resp = await fetch(GAS_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });

    const j = await resp.json();
    if(j.success){
      statusMsg.textContent = 'Laporan terkirim. ID: ' + j.id;
      document.getElementById('laporForm').reset();
      preview.style.display = "none";
      imgData = null;
    }else{
      statusMsg.textContent = 'Gagal: ' + (j.error || 'Unknown');
    }

  }catch(err){
    statusMsg.textContent = 'Error: ' + err;
  }
});
</script>
</body>
</html>
