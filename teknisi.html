<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Teknisi — Aplikasi Lapor</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h1>Panel Teknisi</h1>

    <section class="card">
      <h2>Daftar Teknisi</h2>
      <div>
        <input id="newTeknisi" placeholder="Tambah nama teknisi..." />
        <button id="btnAddTek">Tambah</button>
      </div>
      <ul id="listTeknisi"></ul>
    </section>

    <section class="card">
      <h2>Daftar Laporan</h2>
      <div id="laporanList">Memuat...</div>
    </section>
  </main>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbycJc7oMgPazk-IPfeE7F7GaFsMK9NWZM6bylP91rP8kgtqP07XH6goyqGltE32jIl6/exec";

async function fetchReports(){
  const r = await fetch(GAS_URL + '?action=list');
  const j = await r.json();
  return j.data || [];
}

async function fetchTeknisi(){
  const r = await fetch(GAS_URL + '?action=techs');
  const j = await r.json();
  return j.techs || [];
}

function renderLaporan(list, techs){
  const container = document.getElementById('laporanList');
  if(!list.length){ container.innerHTML = '<p>Belum ada laporan.</p>'; return; }
  container.innerHTML = '';
  const ul = document.createElement('ul');
  ul.className = 'list';
  list.forEach(item => {
    const li = document.createElement('li');
    li.innerHTML = `
      <div class="left">
        <strong>${item.nama}</strong> — ${item.jenis} — <em>${item.divisi}</em><br/>
        <small>${item.tanggal} ${item.jam}</small><p>${item.deskripsi}</p>
        ${item.fotoUrl ? `<a href="${item.fotoUrl}" target="_blank">Lihat foto</a>` : ''}
      </div>
      <div class="right">
        <label>Teknisi:
          <select data-id="${item.rowId}" class="selTech">
            <option value="">- pilih -</option>
            ${techs.map(t=>`<option value="${t}">${t}</option>`).join('')}
          </select>
        </label>
        <label>Status:
          <select data-id="${item.rowId}" class="selStatus">
            <option value="Masuk">Masuk</option>
            <option value="Proses">Proses</option>
            <option value="Selesai">Selesai</option>
          </select>
        </label>
        <div class="btns">
          <button class="btnSave" data-id="${item.rowId}">Simpan</button>
        </div>
      </div>
    `;
    // set current values after DOM inserted
    setTimeout(()=> {
      const selT = li.querySelector('.selTech');
      const selS = li.querySelector('.selStatus');
      selT.value = item.teknisi || '';
      selS.value = item.status || 'Masuk';
    },0);
    ul.appendChild(li);
  });
  container.appendChild(ul);

  // add event for save buttons
  container.querySelectorAll('.btnSave').forEach(btn=>{
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const parent = btn.closest('li');
      const teknisi = parent.querySelector('.selTech').value;
      const status = parent.querySelector('.selStatus').value;
      btn.textContent = 'Menyimpan...';
      const resp = await fetch(GAS_URL + '?action=update', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ rowId: id, teknisi, status })
      });
      const j = await resp.json();
      btn.textContent = j.success ? 'Tersimpan' : 'Gagal';
      setTimeout(()=>btn.textContent='Simpan',1500);
      loadAll();
    });
  });
}

async function loadAll(){
  const [reports, techs] = await Promise.all([fetchReports(), fetchTeknisi()]);
  renderLaporan(reports, techs);
  renderTeknisiList(techs);
}

function renderTeknisiList(techs){
  const ul = document.getElementById('listTeknisi');
  ul.innerHTML = techs.length ? techs.map(t=>`<li>${t}</li>`).join('') : '<li>Belum ada teknisi</li>';
}

document.getElementById('btnAddTek').addEventListener('click', async ()=>{
  const name = document.getElementById('newTeknisi').value.trim();
  if(!name) return alert('Masukkan nama teknisi');
  const r = await fetch(GAS_URL + '?action=addtech', {
    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({nama:name})
  });
  const j = await r.json();
  if(j.success) {
    document.getElementById('newTeknisi').value='';
    loadAll();
  } else alert('Gagal: ' + (j.error || 'unknown'));
});

loadAll();
</script>
</body>
</html>
