<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Panel Teknisi</title>
<link rel="stylesheet" href="style.css">
<link rel="manifest" href="manifest.json">
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js');
}
</script>
<style>
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:6px; text-align:left; }
select, button, input { padding:6px; margin-right:4px; border-radius:6px; }
</style>
</head>
<body>
<main>
<h1>Panel Teknisi</h1>

<label>Nama Teknisi
  <input type="text" id="namaTeknisi" placeholder="Ketik nama / pilih" />
  <button id="addTech">Tambah Nama</button>
</label>

<table id="tblLaporan">
  <thead>
    <tr>
      <th>ID</th><th>Nama</th><th>Divisi</th><th>Jenis</th>
      <th>Deskripsi</th><th>Foto</th><th>Status</th><th>Teknisi</th><th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="statusMsg"></div>
</main>

<script>
const tblBody = document.querySelector('#tblLaporan tbody');
const statusMsg = document.getElementById('statusMsg');
const namaTeknisiInput = document.getElementById('namaTeknisi');

function loadLaporan(){
  google.script.run.withSuccessHandler(renderLaporan).apiGetLaporan();
}

function renderLaporan(data){
  tblBody.innerHTML = '';
  data.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.rowId}</td>
      <td>${r.Nama}</td>
      <td>${r.Divisi}</td>
      <td>${r.Jenis}</td>
      <td>${r.Deskripsi}</td>
      <td>${r.FotoUrl?'<a href="'+r.FotoUrl+'" target="_blank">Lihat</a>':''}</td>
      <td>${r.Status}</td>
      <td>${r.Teknisi}</td>
      <td>
        <select class="statusSel">
          <option value="Proses" ${r.Status==='Proses'?'selected':''}>Proses</option>
          <option value="Selesai" ${r.Status==='Selesai'?'selected':''}>Selesai</option>
        </select>
        <button class="btnUpdate">Update</button>
      </td>`;
    tblBody.appendChild(tr);

    const btn = tr.querySelector('.btnUpdate');
    const sel = tr.querySelector('.statusSel');
    btn.onclick = () => {
      google.script.run.withSuccessHandler(resp=>{
        if(resp.success){ statusMsg.textContent='Update berhasil'; loadLaporan(); }
        else statusMsg.textContent='Error: '+resp.error;
      }).apiUpdateLaporan(r.rowId, sel.value, namaTeknisiInput.value);
    };
  });
}

document.getElementById('addTech').onclick = () => {
  const nama = namaTeknisiInput.value.trim();
  if(!nama) return alert('Isi nama teknisi');
  google.script.run.withSuccessHandler(resp=>{
    if(resp.success){ alert('Teknisi ditambahkan'); loadLaporan(); namaTeknisiInput.value=''; }
    else alert('Gagal: '+resp.error);
  }).apiAddTeknisi(nama);
};

loadLaporan();
setInterval(loadLaporan,10000); // refresh tiap 10 detik
</script>
</body>
</html>
