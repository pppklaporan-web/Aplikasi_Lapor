<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Teknisi</title>

<style>
body { font-family: Arial, sans-serif; padding: 15px; background: #f4f4f4; }
.card {
  background: white; padding: 15px; border-radius: 10px;
  margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
input, button { padding: 10px; margin-top: 5px; width: 95%; }
button { cursor: pointer; border: none; border-radius: 5px; }
.loginBtn { background: #007bff; color: white; }

table { width: 100%; margin-top: 15px; border-collapse: collapse; background: white; }
th, td { padding: 10px; border-bottom: 1px solid #ddd; }
th { background: #007bff; color: white; }

.ambil { background: #28a745; color: white; padding: 8px; border-radius: 5px; }
.selesai { background: #dc3545; color: white; padding: 8px; border-radius: 5px; }

.rowDone { background: #d4edda !important; } /* hijau */
</style>
</head>
<body>

<h2 style="text-align:center">Dashboard Teknisi</h2>

<!-- ========================== -->
<!-- FORM LOGIN                -->
<!-- ========================== -->
<div id="loginCard" class="card">
  <h3>Login Teknisi</h3>
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button class="loginBtn" onclick="login()">Masuk</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<!-- ========================== -->
<!-- DASHBOARD TEKNISI         -->
<!-- ========================== -->
<div id="dashboard" style="display:none">

  <div class="card">
    <h3>Daftar Pekerjaan</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Nama</th><th>Jenis</th><th>Deskripsi</th>
          <th>Teknisi</th><th>Status</th><th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tabelLaporan"></tbody>
    </table>
  </div>

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwfjO3BiO1sd3cIV5i3jYMF5ORmsGb4zJEmjmTnMpUhbTxClZ5xIqjrEJtw5Vj9RZi6Rw/exec";

let teknisiLogin = "";

/* ============================
   LOGIN TEKNISI
=============================== */
async function login(){
  const user = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();

  if(!user || !pass){
    document.getElementById("loginMsg").innerText = "Isi username & password!";
    return;
  }

  try {
    const res = await fetch(API + "?action=login&u=" + user + "&p=" + pass);
    const json = await res.json();

    if(json.success){
      teknisiLogin = json.nama;
      document.getElementById("loginCard").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      loadLaporan();
      setInterval(loadLaporan, 6000);
    } else {
      document.getElementById("loginMsg").innerText = "Login salah!";
    }
  } catch (err){
    document.getElementById("loginMsg").innerText = "Tidak bisa menghubungi server!";
  }
}

/* ============================
   MUAT DAFTAR LAPORAN
=============================== */
async function loadLaporan(){
  try {
    const res = await fetch(API + "?action=list");
    const json = await res.json();

    const tbody = document.getElementById("tabelLaporan");
    tbody.innerHTML = "";

    json.data.forEach(row => {

      // sembunyikan yang selesai
      if(row.Status === "Selesai") return;

      const tr = document.createElement("tr");

      if(row.Teknisi === teknisiLogin && row.Status === "Selesai"){
        tr.classList.add("rowDone");
      }

      let btn = "";

      if(row.Status === "Masuk"){
        btn = `<button class='ambil' onclick="ambil(${row.rowId})">Ambil</button>`;
      } 
      else if(row.Status === "Proses" && row.Teknisi === teknisiLogin){
        btn = `<button class='selesai' onclick="selesai(${row.rowId})">Selesai</button>`;
      }

      tr.innerHTML = `
        <td>${row.rowId}</td>
        <td>${row.Nama}</td>
        <td>${row.Jenis}</td>
        <td>${row.Deskripsi}</td>
        <td>${row.Teknisi}</td>
        <td>${row.Status}</td>
        <td>${btn}</td>
      `;
      tbody.appendChild(tr);
    });

  } catch(err){
    console.log("Gagal load:", err);
  }
}

/* ============================
   AMBIL PEKERJAAN
=============================== */
async function ambil(id){
  await fetch(API, {
    method: "POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      action:"update",
      rowId:id,
      teknisi: teknisiLogin,
      status:"Proses"
    })
  });

  loadLaporan();
}

/* ============================
   SELESAIKAN PEKERJAAN
=============================== */
async function selesai(id){
  await fetch(API, {
    method: "POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      action:"update",
      rowId:id,
      teknisi: teknisiLogin,
      status:"Selesai"
    })
  });

  loadLaporan();
}

</script>
</body>
</html>
