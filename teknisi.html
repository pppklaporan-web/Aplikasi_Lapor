<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Panel Teknisi</title>
<link rel="stylesheet" href="style.css">
<script>
if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>
<style>
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:6px; text-align:left; }
select, button, input { padding:6px; margin-right:4px; border-radius:6px; }
</style>
</head>
<body>
<main>
<h1>Panel Teknisi</h1>

<label>Nama Teknisi
  <input list="listTeknisi" id="namaTeknisi" placeholder="Pilih atau ketik nama teknisi">
  <datalist id="listTeknisi"></datalist>
</label>

<table id="tblLaporan">
  <thead>
    <tr>
      <th>ID</th><th>Nama</th><th>Divisi</th><th>Jenis</th>
      <th>Deskripsi</th><th>Foto</th><th>Status</th><th>Teknisi</th><th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="statusMsg"></div>
</main>

<script>
const GAS_URL="https://script.google.com/macros/s/AKfycbwfjO3BiO1sd3cIV5i3jYMF5ORmsGb4zJEmjmTnMpUhbTxClZ5xIqjrEJtw5Vj9RZi6Rw/exec";

const tblBody=document.querySelector('#tblLaporan tbody');
const statusMsg=document.getElementById('statusMsg');
const namaTeknisiInput=document.getElementById('namaTeknisi');

async function loadTeknisiList(){
  const resp = await fetch(GAS_URL+'?action=techs');
  const j = await resp.json();
  if(j.success){
    const dl = document.getElementById('listTeknisi');
    dl.innerHTML='';
    j.techs.forEach(n=>{
      const opt=document.createElement('option');
      opt.value=n;
      dl.appendChild(opt);
    });
  }
}

async function loadLaporan(){
  const resp = await fetch(GAS_URL+'?action=list');
  const j = await resp.json();
  if(!j.success){ statusMsg.textContent="Error load laporan"; return; }
  tblBody.innerHTML='';

  const teknisiName = namaTeknisiInput.value.trim();
  j.data.forEach(r=>{
    // Tampilkan yang belum selesai atau yang diambil teknisi ini
    if(r.Status==='Selesai') return;
    if(r.Teknisi && r.Teknisi!==teknisiName) return; // hindari pekerjaan teknisi lain

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.rowId}</td>
      <td>${r.Nama}</td>
      <td>${r.Divisi}</td>
      <td>${r.Jenis}</td>
      <td>${r.Deskripsi}</td>
      <td>${r.FotoUrl?'<a href="'+r.FotoUrl+'" target="_blank">Lihat</a>':''}</td>
      <td>${r.Status}</td>
      <td>${r.Teknisi||''}</td>
      <td>
        ${r.Teknisi ? 
          `<select class="statusSel">
             <option value="Proses" ${r.Status==='Proses'?'selected':''}>Proses</option>
             <option value="Selesai" ${r.Status==='Selesai'?'selected':''}>Selesai</option>
           </select>
           <button class="btnUpdate">Update</button>`
        : `<button class="btnAmbil">Ambil Pekerjaan</button>`}
      </td>`;
    tblBody.appendChild(tr);

    if(r.Teknisi){
      const btn=tr.querySelector('.btnUpdate');
      const sel=tr.querySelector('.statusSel');
      btn.onclick=async()=>{
        if(!teknisiName){ alert('Isi nama teknisi'); return; }
        const data={action:'update',rowId:r.rowId,status:sel.value,teknisi:teknisiName};
        const resp=await fetch(GAS_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(data)
        });
        const j=await resp.json();
        if(j.success){ statusMsg.textContent='Update berhasil'; loadLaporan(); loadTeknisiList(); }
        else statusMsg.textContent='Error: '+j.error;
      };
    } else {
      const btnAmbil=tr.querySelector('.btnAmbil');
      btnAmbil.onclick=async()=>{
        if(!teknisiName){ alert('Isi nama teknisi'); return; }
        const data={action:'update',rowId:r.rowId,status:'Proses',teknisi:teknisiName};
        const resp=await fetch(GAS_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(data)
        });
        const j=await resp.json();
        if(j.success){ statusMsg.textContent='Pekerjaan diambil'; loadLaporan(); loadTeknisiList(); }
        else statusMsg.textContent='Error: '+j.error;
      };
    }
  });
}

loadTeknisiList();
loadLaporan();
setInterval(loadLaporan,10000);
</script>
</body>
</html>
