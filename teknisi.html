<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Teknisi</title>
<link rel="stylesheet" href="style.css">
<script>
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js');
  }
</script>
<style>
body { font-family:sans-serif; padding:10px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:6px; text-align:left; }
select, button, input { padding:6px; margin-right:4px; border-radius:6px; }
</style>
</head>
<body>
<main>
<h1>Panel Teknisi</h1>

<label>Nama Teknisi:
  <input type="text" id="namaTeknisi" placeholder="Ketik nama atau pilih dari daftar"/>
  <button id="addTech">Tambah Nama</button>
</label>

<table id="tblLaporan">
<thead>
<tr>
<th>ID</th><th>Nama</th><th>Divisi</th><th>Jenis</th>
<th>Deskripsi</th><th>Foto</th><th>Status</th><th>Teknisi</th><th>Aksi</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="statusMsg"></div>
</main>

<script>
const GAS_URL="https://script.google.com/macros/s/AKfycbwfjO3BiO1sd3cIV5i3jYMF5ORmsGb4zJEmjmTnMpUhbTxClZ5xIqjrEJtw5Vj9RZi6Rw/exec"; // ganti dengan GAS URL mu

const tblBody=document.querySelector('#tblLaporan tbody');
const statusMsg=document.getElementById('statusMsg');
const namaTeknisiInput=document.getElementById('namaTeknisi');

async function loadLaporan(){
  statusMsg.textContent='Memuat data...';
  try{
    const resp=await fetch(GAS_URL+'?action=list');
    const j=await resp.json();
    if(!j.success){ statusMsg.textContent='Gagal load laporan'; return; }

    tblBody.innerHTML='';
    j.data.forEach(r=>{
      // tampilkan semua laporan yang belum selesai
      if(r.Status==='Selesai') return;
      const tr=document.createElement('tr');
      tr.innerHTML=`
      <td>${r.rowId}</td>
      <td>${r.Nama}</td>
      <td>${r.Divisi}</td>
      <td>${r.Jenis}</td>
      <td>${r.Deskripsi}</td>
      <td>${r.FotoUrl?'<a href="'+r.FotoUrl+'" target="_blank">Lihat</a>':''}</td>
      <td>
        <select class="statusSel">
          <option value="Proses" ${r.Status==='Proses'?'selected':''}>Proses</option>
          <option value="Selesai" ${r.Status==='Selesai'?'selected':''}>Selesai</option>
        </select>
      </td>
      <td>${r.Teknisi}</td>
      <td><button class="btnUpdate">Update</button></td>`;
      tblBody.appendChild(tr);

      const btn=tr.querySelector('.btnUpdate');
      const sel=tr.querySelector('.statusSel');

      btn.onclick=async()=>{
        const data={
          action:'update',
          rowId:r.rowId,
          teknisi:namaTeknisiInput.value.trim() || r.Teknisi,
          status:sel.value
        };
        const resp=await fetch(GAS_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(data)
        });
        const res=await resp.json();
        if(res.success){
          statusMsg.textContent='Update berhasil';
          loadLaporan();
        } else {
          statusMsg.textContent='Error: '+res.error;
        }
      };
    });
    statusMsg.textContent='Selesai load data';
  }catch(err){
    statusMsg.textContent='Error: '+err;
  }
}

// tambah nama teknisi ke daftar di GAS
document.getElementById('addTech').onclick=async()=>{
  const nama=namaTeknisiInput.value.trim();
  if(!nama) return alert('Isi nama teknisi');
  try{
    const resp=await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'addtech',nama})
    });
    const j=await resp.json();
    if(j.success){ alert('Teknisi ditambahkan'); namaTeknisiInput.value=''; loadLaporan(); }
    else alert('Gagal: '+j.error);
  }catch(err){ alert('Error: '+err); }
};

loadLaporan();
setInterval(loadLaporan,15000); // refresh tiap 15 detik
</script>
</body>
</html>
