<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Public Dashboard - Laporan Kendala</title>
<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; padding:10px; margin:0; }
  .container { max-width:1200px; margin:auto; background:#fff; padding:15px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
  h2 { text-align:center; margin-bottom:10px; }
  .table-container { overflow-x:auto; margin-top:15px; }
  table { width:100%; border-collapse: collapse; min-width:700px; }
  th, td { padding:10px; border:1px solid #ccc; background:white; text-align:center; cursor:pointer; }
  th { background:#333; color:white; }
  img { width:80px; border-radius:6px; cursor:pointer; transition:0.2s; }
  img:hover { transform: scale(1.5); z-index:10; position:relative; }
  #loading { text-align:center; font-weight:bold; margin-top:20px; }
  select { padding:5px; margin-bottom:10px; }
  .status-menunggu { background: #ffeb3b; color:#000; font-weight:bold; border-radius:4px; padding:2px 6px; }
  .status-selesai { background: #4caf50; color:#fff; font-weight:bold; border-radius:4px; padding:2px 6px; }

  @media (max-width: 600px) {
    table, th, td { font-size:12px; }
    img { width:50px; }
  }
</style>
</head>
<body>

<div class="container">
  <h2>ðŸ“‹ Public Dashboard - Laporan Kendala Pegawai</h2>

  <!-- Filter Ruangan -->
  <label for="filterRuangan">Filter Ruangan:</label>
  <select id="filterRuangan">
    <option value="all">Semua Ruangan</option>
  </select>

  <div id="loading">Memuat data...</div>

  <div class="table-container">
    <table id="tabel" style="display:none;">
      <thead>
        <tr>
          <th data-column="waktu">Waktu â–²â–¼</th>
          <th data-column="nama">Nama â–²â–¼</th>
          <th data-column="ruangan">Ruangan â–²â–¼</th>
          <th data-column="keterangan">Keterangan â–²â–¼</th>
          <th>Foto</th>
          <th data-column="status">Status â–²â–¼</th>
          <th data-column="teknisi">Teknisi â–²â–¼</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxcvVSxw6liSor0zj03SjbxBiMryQ9PE2vGYQOY786K6-GauDstEnsRUZ_zid5An3uZtA/exec"; // ganti sesuai deploy Apps Script
let rawData = [];
let sortColumn = null;
let sortAsc = true;

// Fungsi load data
async function loadData() {
  const loading = document.getElementById("loading");
  const table = document.getElementById("tabel");
  const filterSelect = document.getElementById("filterRuangan");

  try {
    const res = await fetch(API_URL);
    const json = await res.json();

    if (json.status !== "success") {
      loading.innerText = "Gagal mengambil data: " + (json.message || "Unknown error");
      return;
    }

    rawData = json.data;

    // Isi filter ruangan otomatis
    const ruanganSet = new Set(rawData.map(d => d.ruangan).filter(r => r));
    filterSelect.innerHTML = '<option value="all">Semua Ruangan</option>';
    ruanganSet.forEach(r => {
      filterSelect.innerHTML += `<option value="${r}">${r}</option>`;
    });

    renderTable(rawData);

  } catch (e) {
    loading.innerText = "Terjadi error saat memuat data: " + e;
  }
}

// Fungsi render tabel
function renderTable(data) {
  const loading = document.getElementById("loading");
  const table = document.getElementById("tabel");
  loading.style.display = "none";
  table.style.display = "table";

  const tb = table.querySelector("tbody");
  tb.innerHTML = "";

  if (!data || data.length === 0) {
    tb.innerHTML = "<tr><td colspan='7'>Tidak ada data</td></tr>";
    return;
  }

  data.forEach(r => {
    let statusClass = r.status.toLowerCase() === "selesai" ? "status-selesai" : "status-menunggu";
    tb.innerHTML += `
      <tr>
        <td>${r.waktu}</td>
        <td>${r.nama}</td>
        <td>${r.ruangan}</td>
        <td>${r.keterangan}</td>
        <td>${r.foto ? `<img src="${r.foto}" alt="foto">` : "-"}</td>
        <td><span class="${statusClass}">${r.status}</span></td>
        <td>${r.teknisi}</td>
      </tr>
    `;
  });
}

// Filter ruangan
document.getElementById("filterRuangan").addEventListener("change", function() {
  const value = this.value;
  let filtered = value === "all" ? rawData : rawData.filter(d => d.ruangan === value);
  renderTable(filtered);
});

// Sort kolom
document.querySelectorAll("th[data-column]").forEach(th => {
  th.addEventListener("click", () => {
    const col = th.getAttribute("data-column");
    if(sortColumn === col) sortAsc = !sortAsc;
    else { sortColumn = col; sortAsc = true; }

    const dataCopy = [...rawData];
    dataCopy.sort((a,b) => {
      let valA = a[col] || "";
      let valB = b[col] || "";
      return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
    });

    const filterValue = document.getElementById("filterRuangan").value;
    let finalData = filterValue === "all" ? dataCopy : dataCopy.filter(d => d.ruangan === filterValue);

    renderTable(finalData);
  });
});

loadData();
</script>

</body>
</html>
